@{
    ViewBag.pTitle = "Role Manage";
    ViewBag.pageTitle = "InfoTrack";
    ViewBag.Title = "Role Manage";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int i = 1;
}
@section styles {
    <!-- jquery.vectormap css -->
    <link href="~/libs/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.css" rel="stylesheet" type="text/css" />

    <!-- DataTables -->
    <link href="~/libs/datatables.net-bs4/css/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css" />
    <link href="~/libs/datatables.net-buttons-bs4/css/buttons.bootstrap4.min.css" rel="stylesheet" type="text/css" />
    <link href="~/libs/datatables.net-select-bs4/css//select.bootstrap4.min.css" rel="stylesheet" type="text/css" />
    <!-- Responsive datatable examples -->
    <link href="~/libs/datatables.net-responsive-bs4/css/responsive.bootstrap4.min.css" rel="stylesheet" type="text/css" />

}



<style>
    .add_hover:hover{
        border-top: 1px solid #604acb;
    }

    .active_hover{
        border-top: 1px solid green;
    }
    .card {
        margin-bottom: 0.4rem;
    }

    .card-header {
        background-color: white !important;
    }

    .bg-color {
        background-color: #5664d2;
    }

        .bg-color:hover {
            background-color: #5664d2;
            color: white;
        }


    table#datatable > tbody > tr > td {
        padding: 6px;
        font-size: 12px;
    }
</style>

<div class="row">
    <div class="col-xl-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">User Role Permission</h5>

            </div>
            <div class="card-body">
                <div id="noticeMessage" class="alert alert-dismissible fade d-none" role="alert">
                    <span id="noticeText"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4 col-sm-6">
                        <div class="form-group">
                            <label for="uservalue" class="form-label">User Name</label>
                            @Html.DropDownList("UserId", ViewBag.user as SelectList, new { @class = "form-control", @id = "userId", onchange = "RolePermission()" })
                        </div>
                    </div>
                </div>               
               
                <div class="mt-5 mb-4 d-none" id="hiddenButton">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-semibold text-dark mb-0">
                            <i class="bi bi-people-fill me-2"></i>
                            Select User Role
                        </h5>
                        <a id="updateBtn" class="btn btn-info btn-sm">Update</a>
                    </div>
                    <div id="roleShow"></div>                 
                </div>
            </div>
        </div>

    </div>
</div>

@section scripts {
    <!-- apexcharts -->
    <!-- jquery.vectormap map -->
    <script src="~/libs/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.min.js"></script>
    <script src="~/libs/admin-resources/jquery.vectormap/maps/jquery-jvectormap-us-merc-en.js"></script>
    <!-- Required datatable js -->
    <script src="~/libs/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="~/libs/datatables.net-bs4/js/dataTables.bootstrap4.min.js"></script>
    <!-- Buttons examples -->
    <script src="~/libs/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/libs/datatables.net-buttons-bs4/js/buttons.bootstrap4.min.js"></script>
    <script src="~/libs/jszip/jszip.min.js"></script>
    <script src="~/libs/pdfmake/build/pdfmake.min.js"></script>
    <script src="~/libs/pdfmake/build/vfs_fonts.js"></script>
    <script src="~/libs/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="~/libs/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="~/libs/datatables.net-buttons/js/buttons.colVis.min.js"></script>
    <script src="~/libs/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="~/libs/datatables.net-select/js/dataTables.select.min.js"></script>
    <!-- Responsive examples -->
    <script src="~/libs/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/libs/datatables.net-responsive-bs4/js/responsive.bootstrap4.min.js"></script>
    <!-- Datatable init js -->
    <script src="~/js/pages/datatables.init.js"></script>
    <script src="~/js/app.js"></script>


    }

<script src="~/lib/jquery/dist/jquery.min.js"></script>

<script>
         $(document).ready(function () {
            const message = localStorage.getItem('metaSuccessMessage');

            if (message) {
                const notice = $('#noticeMessage');
                const text = $('#noticeText');

                // ✅ Show the alert
                text.text(message);
                notice.removeClass('d-none fade alert-danger');
                notice.addClass('alert alert-success show');

                // ✅ Remove message after showing
                localStorage.removeItem('metaSuccessMessage');
            }
         });


      function RolePermission(){

          var id=$("#userId").val();

          fetch(`/Security/Security/UserRolePermission?id=${id}`, {
              method: 'GET',
              headers: {'Content-Type': 'application/json'}

          })
          .then(response => response.json())
          .then(res => {
              
            if(res.data.length>0){
                $('#hiddenButton').removeClass("d-none","");
                loadtableBody(res.data);
              }else{
                $('#hiddenButton').addClass("d-none");
               
              }
          })
          .catch(error => {

              alert('Error while saving.');
          });

      }

      function loadtableBody(data)
      {
         
          const des= document.getElementById('roleShow');
          let  datashow='';
        debugger;
          data.forEach((item, index) => {
            const isChecked = item.isActive===1 ? 'checked' : '';
            const focusbtn=item.isActive===1?" active_hover":"";
          // Start new row every 3 items
        debugger;
              if (index % 3 === 0) {
                  datashow += '<div class="row g-3 mb-3">';
                  rowOpen = true;
              }
                let badgesHtml = '';
                  if (item.menuData && item.menuData.length > 0) {
                      item.menuData.forEach(menuName => {
                          badgesHtml += `<span class="badge bg-primary bg-opacity-10 text-primary me-1 mb-1">${menuName}</span>`;
                      });
                  }
              datashow += `
                  <div class="col-md-4">
                    <div class="card role-card border-2 h-100 add_hover ${focusbtn}" data-role="super-admin">
                          <div class="card-body p-4">
                              <div class="d-flex justify-content-between align-items-start mb-3">
                                  <div class="d-flex align-items-center">
                                      <div class="bg-primary text-white rounded-3 p-1 me-3">
                                          <i class="bi bi-database-fill-gear fs-4"></i>
                                      </div>
                                      <div>
                                          <h5 class="card-title mb-1 fw-bold">${item.roleName}</h5>
                                          <p class="card-text text-muted small mb-0">${item.description}</p>
                                      </div>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" data-userid="${item.userId}" data-roleid="${item.roleId}" type="radio" name="userRole"
                                        id="superAdmin${index}" ${isChecked}>
                                  </div>
                              </div>
                              <div class="border-top pt-3">
                             ${badgesHtml}
                                 
                              </div>
                          </div>
                      </div>
                  </div>
              `;

              // Close the row every 3 items or at the end
              if ((index + 1) % 3 === 0 || index === data.length - 1) {
                  datashow += '</div>';
                  rowOpen = false;
              }
          });
        des.innerHTML=datashow;
      }


      $('#updateBtn').on('click', function(){

            const selected = $("input[name='userRole']:checked");
            if (selected.length === 0) {
                alert("Please select a role.");
                return;
            }

            const userId = selected.data("userid");
            const roleId = selected.data("roleid");

            const selectedRole = {
                userId: userId,
                roleId: roleId,
                isActive: true
            };

        fetch(`/Security/Security/UserRolePermissionSave`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
          body:JSON.stringify(selectedRole)
        })
        .then(response => response.json())
        .then(res => {
              const notice = $('#noticeMessage');
              const text = $('#noticeText');
              notice.removeClass('alert-success alert-danger');

              if (!res.status) {
                  
                  text.text(res.message);
                  notice.removeClass('d-none fade').addClass('alert-danger show');
              } else {
                  
                  localStorage.setItem('metaSuccessMessage', res.message);
                  location.reload(); // ✅ Reload the page
              }
        })
        .catch(error => {

            alert('Error while saving.');
        });
        
      });
</script>